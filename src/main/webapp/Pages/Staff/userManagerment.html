<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý học viên</title>
    <link rel="stylesheet" href="/Assets/Css/main.css">
    <link rel="stylesheet" href="/Assets/Css/Staff/userManagerment.css">
    <link rel="stylesheet" href="/Assets/Css/Components/sideBar.css">
    <link rel="stylesheet" href="/Assets/Css/Components/theme.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .user-manager-container { margin-left: 280px; padding: 2rem; }
        .search-bar { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .search-bar input, .search-bar select { padding: 0.5rem; border-radius: 5px; border: 1px solid #ccc; }
        .user-table { width: 100%; border-collapse: collapse; background: #fff; }
        .user-table th, .user-table td { padding: 0.75rem; border-bottom: 1px solid #eee; text-align: left; }
        .user-table th { background: #f5f7fa; }
        .user-table tr:hover { background: #f0f8ff; }
        .action-btn { background: none; border: none; cursor: pointer; margin-right: 6px; font-size: 1.1rem; }
        .action-btn[disabled] { color: #ccc; cursor: not-allowed; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.2); align-items: center; justify-content: center; }
        .modal-content { background: #fff; padding: 2rem; border-radius: 10px; min-width: 350px; }
        .modal-header { font-weight: bold; margin-bottom: 1rem; }
        .close-modal { float: right; cursor: pointer; color: #888; }
        .user-table td {
            vertical-align: middle;
        }
        .user-table .action-btn {
            opacity: 1 !important; /* Luôn hiển thị */
            transition: color 0.2s, background 0.2s;
            margin-right: 8px;
            color: #4a90e2;
            border-radius: 4px;
            padding: 4px 6px;
        }
        .user-table .action-btn:hover:not([disabled]) {
            background: #e3f0fc;
            color: #357abd;
        }
        .user-table tr td .action-btn { opacity: 0; }
        .user-table tr:hover td .action-btn { opacity: 1; }
    </style>
</head>
<body>
    <div id="sidebar"></div>
    <div class="user-manager-container">
        <h1>Quản lý học viên</h1>
        <!-- Thanh tìm kiếm và bộ lọc -->
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Tìm theo tên, email, mã học viên...">
            <!-- <select id="courseFilter">
                <option value="">Tất cả khóa học</option>
                <option>Tiếng Anh A1</option>
                <option>Tiếng Anh B1</option>
            </select>
            <select id="statusFilter">
                <option value="">Tất cả trạng thái</option>
                <option value="active">Đang học</option>
                <option value="inactive">Nghỉ</option>
            </select> -->
            <button onclick="searchUser()" class=" btn "><i class="fas fa-search"></i> Tìm kiếm</button>
            <!-- <button onclick="showAddUserModal()" class="add-btn"><i class="fas fa-plus"></i> Thêm mới</button> -->

        </div>
        <!-- Bảng danh sách học viên -->
        <table class="user-table" id="userTable">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Họ tên</th>
                    <th>Email</th>
                    <th>Khóa học</th>
                    <th>Tiến độ (%)</th>
                    <th>Ngày tạo</th>
                    <th>Tác vụ</th>
                </tr>
            </thead>
            <tbody>
                <!-- Dữ liệu sẽ được render bằng JS -->
            </tbody>
        </table>
        <div id="userPagination" style="margin-top: 1rem; text-align: right;"></div>
    </div>

    <!-- Modal chi tiết học viên -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('detailModal')">&times;</span>
            <div id="detailContent"></div>
        </div>
    </div>

    <!-- Modal sửa học viên -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('editModal')">&times;</span>
            <div id="editContent"></div>
        </div>
    </div>

    <!-- Modal thêm người dùng -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('addUserModal')">&times;</span>
            <div id="addUserContent"></div>
        </div>
    </div>
    <script src="/Javascript/GetAPI/getInfor.js"></script>
    <script src="/Javascript/components/sideBar.js"></script>
    <script src="/Javascript/GetAPI/userManagermentAPI.js"></script>
    <script>
        let users = [];
        let usersPerPage = 10;
        let currentUserPage = 1;

        // Lấy role từ localStorage
        const role = localStorage.getItem('Role');

        // Lấy danh sách user từ API khi load trang
        async function loadUsers() {
            try {
                const data = await getUserListByRole(2); // 2 là role_id của học viên
                users = data.map((item, idx) => ({
                    id: item.user.user_id,
                    code: item.user.code || `HV${String(idx + 1).padStart(3, '0')}`,
                    name: item.user.name,
                    email: item.account ? item.account.email : '(chưa có tài khoản)',
                    username: item.account ? item.account.username : '(chưa có tài khoản)',
                    status: item.user.status || 'active',
                    created: item.user.created || '',
                    createdBy: item.user.createdBy || ''
                }));
                renderUserTable();
                renderUserPagination();
            } catch (err) {
                alert('Không thể tải danh sách học viên!');
            }
        }

        function renderUserTable() {
            const tbody = document.querySelector('#userTable tbody');
            const start = (currentUserPage - 1) * usersPerPage;
            const end = start + usersPerPage;
            const pageData = users.slice(start, end);

            tbody.innerHTML = pageData.map((u, idx) => `
                <tr>
                    <td>${start + idx + 1}</td>
                    <td>${u.code}</td>
                    <td>${u.name}</td>
                    <td>${u.email}</td>
                    <td>${u.username}</td>
                    <td>
                        <span class="status-badge ${u.status === 'active' ? 'status-active' : 'status-locked'}">
                            ${u.status === 'active' ? 'Hoạt động' : 'Đã khóa'}
                        </span>
                    </td>
                    <td>
                        <button class="action-btn" title="Chỉnh sửa" onclick="showEditUser(${u.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn ${u.status === 'active' ? 'lock' : 'unlock'}" 
                                title="${u.status === 'active' ? 'Khóa' : 'Mở khóa'}" 
                                onclick="toggleLockUser(${u.id})">
                            <i class="fas fa-${u.status === 'active' ? 'lock' : 'unlock'}"></i>
                        </button>
                        <button class="action-btn delete" title="Xóa" onclick="deleteUser(${u.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderUserPagination() {
            const totalPages = Math.ceil(users.length / usersPerPage);
            const pagination = document.getElementById('userPagination');
            if (!pagination) return;

            let html = '';
            html += `<button onclick="changeUserPage(-1)" ${currentUserPage === 1 ? 'disabled' : ''}>Trước</button>`;
            html += ` Trang ${currentUserPage} / ${totalPages} `;
            html += `<button onclick="changeUserPage(1)" ${currentUserPage === totalPages ? 'disabled' : ''}>Sau</button>`;
            pagination.innerHTML = html;
        }

        function changeUserPage(delta) {
            const totalPages = Math.ceil(users.length / usersPerPage);
            currentUserPage += delta;
            if (currentUserPage < 1) currentUserPage = 1;
            if (currentUserPage > totalPages) currentUserPage = totalPages;
            renderUserTable();
            renderUserPagination();
        }

        function searchUser() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const course = document.getElementById('courseFilter').value;
            const status = document.getElementById('statusFilter').value;
            let filtered = users.filter(u =>
                (u.name.toLowerCase().includes(keyword) || u.email.toLowerCase().includes(keyword) || u.id.toString().includes(keyword)) &&
                (course === "" || u.code.includes(course)) &&
                (status === "" || u.status === status)
            );
            users = filtered;
            renderUserTable();
            renderUserPagination();
        }

        function showEditUser(id) {
            const u = users.find(x => x.id === id);
            if (!u) return;
            document.getElementById('editContent').innerHTML = `
                <h2>Chỉnh sửa học viên</h2>
                <form onsubmit="saveEdit(event,${u.id})">
                    <label>Họ tên: <input type="text" id="editName" value="${u.name}"></label><br><br>
                    <label>Email: <input type="email" id="editEmail" value="${u.email}"></label><br><br>
                    <label>Khóa học: <input type="text" id="editCode" value="${u.code}"></label><br><br>
                    <label>Trạng thái: <select id="editStatus">
                        <option value="active" ${u.status === 'active' ? 'selected' : ''}>Hoạt động</option>
                        <option value="inactive" ${u.status === 'inactive' ? 'selected' : ''}>Đã khóa</option>
                    </select></label><br><br>
                    <button type="submit">Lưu</button>
                </form>
            `;
            document.getElementById('editModal').style.display = 'flex';
        }

        function saveEdit(e, id) {
            e.preventDefault();
            const u = users.find(x => x.id === id);
            u.name = document.getElementById('editName').value;
            u.email = document.getElementById('editEmail').value;
            u.code = document.getElementById('editCode').value;
            u.status = document.getElementById('editStatus').value;
            closeModal('editModal');
            renderUserTable();
        }

        function deleteUser(id) {
            if (confirm('Bạn chắc chắn muốn xóa học viên này? Hành động này không thể hoàn tác.')) {
                // Nếu muốn gọi API xóa thì gọi ở đây, ví dụ: await deleteUserAPI(id);
                const idx = users.findIndex(x => x.id === id);
                if (idx > -1) users.splice(idx, 1);
                // Nếu xóa hết trang hiện tại thì lùi về trang trước
                if ((currentUserPage - 1) * usersPerPage >= users.length && currentUserPage > 1) {
                    currentUserPage--;
                }
                renderUserTable();
                renderUserPagination();
            }
        }

        function toggleLockUser(id) {
            const u = users.find(x => x.id === id);
            if (u) {
                u.status = u.status === 'active' ? 'inactive' : 'active';
                renderUserTable();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showAddUserModal() {
            document.getElementById('addUserContent').innerHTML = `
                <h2>Thêm người dùng mới</h2>
                <form onsubmit="saveAddUser(event)">
                    <label>Username: <input type="text" id="addUsername" required></label><br><br>
                    <label>Password: <input type="password" id="addPassword" required></label><br><br>
                    <label>Email: <input type="email" id="addEmail" required></label><br><br>
                    <label>Họ tên: <input type="text" id="addName" required></label><br><br>
                    <label>Role ID: <input type="number" id="addRoleId" value="2" required></label><br><br>
                    <label>Avatar: <input type="text" id="addAvatar"></label><br><br>
                    <button type="submit">Thêm</button>
                </form>
            `;
            document.getElementById('addUserModal').style.display = 'flex';
        }

        async function saveAddUser(e) {
            e.preventDefault();
            const data = {
                username: document.getElementById('addUsername').value,
                password: document.getElementById('addPassword').value,
                email: document.getElementById('addEmail').value,
                name: document.getElementById('addName').value,
                role_id: document.getElementById('addRoleId').value,
                avatar: document.getElementById('addAvatar').value
            };
            try {
                const res = await createUser(data);
                if (res.message) {
                    closeModal('addUserModal');
                    loadUsers();
                    alert('Thêm người dùng thành công!');
                } else {
                    alert(res.error || 'Có lỗi xảy ra!');
                }
            } catch (err) {
                alert('Lỗi khi thêm người dùng!');
            }
        }

        // Khởi tạo bảng khi load trang
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
        });
    </script>
    <script src="/Javascript/components/theme.js"></script>
</body>
</html>
